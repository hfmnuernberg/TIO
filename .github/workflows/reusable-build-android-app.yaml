name: Build Android App

on:
  workflow_call:
    inputs:
      ref:
        required: true
        type: string
        description: The commit SHA, tag or release to verify
      artifactName:
        required: true
        type: string
        description: The name of the artifact to build

jobs:
  build-android-app:
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - name: Checkout code
        uses: actions/checkout@v4.2.2
        with:
          ref: ${{ inputs.ref }}
          fetch-depth: 0

      - name: Setup Java
        uses: actions/setup-java@v4.7.0
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Flutter
        uses: kuhnroyal/flutter-fvm-config-action/setup@v3.1

      - name: Setup NDK
        id: setup_ndk
        uses: nttld/setup-ndk@v1.5.0
        with:
          ndk-version: r26d
#          link-to-sdk: true
#          local-cache: true

      - name: Print NDK info
        run: |
          echo "ndk-path: ${{ steps.setup_ndk.outputs.ndk-path }}"
          echo "ANDROID_HOME=$ANDROID_HOME"
          echo "ANDROID_SDK_HOME=$ANDROID_SDK_HOME"
          echo "ANDROID_NDK_HOME=$ANDROID_NDK_HOME"
          echo "ANDROID_NDK_ROOT=$ANDROID_NDK_ROOT"
          ls -la ${{ steps.setup_ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin
          ${{ steps.setup_ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/clang --version
          ${{ steps.setup_ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/clang++ --version
#          echo "---"
#          ls -la /home/runner/.setup-ndk/r26d/toolchains/llvm/prebuilt/linux-x86_64/bin/clang++
#          echo "---"
#          ls -la /opt
#          echo "---"
#          ls -la /opt/hostedtoolcache
#          echo "---"
#          ls -la /opt/hostedtoolcache/ndk
#          echo "---"
#          ls -la /opt/hostedtoolcache/ndk/r26d
#          echo "---"
#          ls -la /opt/hostedtoolcache/ndk/r26d/x64
#          echo "---"
#          ls -la /opt/hostedtoolcache/ndk/r26d/x64/toolchains
#          echo "---"
#          ls -la /opt/hostedtoolcache/ndk/r26d/x64/toolchains/llvm
#          echo "---"
#          ls -la /opt/hostedtoolcache/ndk/r26d/x64/toolchains/llvm/prebuilt
#          echo "---"
#          ls -la /opt/hostedtoolcache/ndk/r26d/x64/toolchains/llvm/prebuilt/linux-x86_64
#          echo "---"
#          ls -la /opt/hostedtoolcache/ndk/r26d/x64/toolchains/llvm/prebuilt/linux-x86_64/bin
#          echo "---"
#          chmod +x /opt/hostedtoolcache/ndk/r26d/x64/toolchains/llvm/prebuilt/linux-x86_64/bin/clang
#          echo "---"
#          /opt/hostedtoolcache/ndk/r26d/x64/toolchains/llvm/prebuilt/linux-x86_64/bin/clang --version
#          echo "---"
#          /home/runner/.setup-ndk/r26d/toolchains/llvm/prebuilt/linux-x86_64/bin/clang++ --version
        env:
          ANDROID_NDK_HOME: ${{ steps.setup_ndk.outputs.ndk-path }}
          ANDROID_NDK_ROOT: ${{ steps.setup_ndk.outputs.ndk-path }}

      - name: Install ALSA dev libraries
        run: sudo apt-get update && sudo apt-get install -y libasound2-dev

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1.10.1

      - name: Install cargo-ndk
        run: cargo install cargo-ndk

      - name: Install Flutter dependencies
        run: scripts/app.sh install:flutter:packages

      - name: Install Rust dependencies
        run: scripts/app.sh install:rust:packages

      - name: Install Flutter/Dart<->Rust binding generator
        run: scripts/app.sh install:rust:flutter-rust-bridge-codegen

      - name: Generate Rust TIO music library
        run: scripts/app.sh generate:rust

      - name: Generate splash image assets
        run: scripts/app.sh generate:splash

      - name: Generate launcher icons
        run: scripts/app.sh generate:icon

      - name: Generate json *.g.dart files
        run: scripts/app.sh generate:json

      - name: Setup ruby
        uses: ruby/setup-ruby@v1.221.0
        with:
          ruby-version: '3.3'
          working-directory: android
          bundler-cache: true

      - name: Decrypt key.properties file
        uses: timheuer/base64-to-file@v1.2.4
        with:
          fileName: 'key.properties'
          fileDir: './android'
          encodedString: ${{ secrets.ANDROID_KEYSTORE_PROPERTIES }}

      - name: Decrypt keystore.jks file
        uses: timheuer/base64-to-file@v1.2.4
        with:
          fileName: 'upload.keystore.jks'
          fileDir: './android/app/keystore'
          encodedString: ${{ secrets.ANDROID_KEYSTORE_UPLOAD_JKS }}

      - name: Prepare version
        run: scripts/update-version-and-build-number-in-pubspec-with-latest-tag.sh

      - name: Build bundle
        run: |
          echo $ANDROID_NDK_HOME
          echo $ANDROID_NDK_ROOT
          echo "---"
          export CXX_armv7_linux_androideabi="/home/runner/.setup-ndk/r26d/toolchains/llvm/prebuilt/linux-x86_64/bin/clang++"
          export CC_armv7_linux_androideabi="/home/runner/.setup-ndk/r26d/toolchains/llvm/prebuilt/linux-x86_64/bin/clang"
          export PATH="/home/runner/.setup-ndk/r26d/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH"
          echo "---"
          scripts/app.sh build android release
        env:
          ANDROID_NDK_HOME: ${{ steps.setup_ndk.outputs.ndk-path }}
          ANDROID_NDK_ROOT: ${{ steps.setup_ndk.outputs.ndk-path }}

      - name: Save bundle
        uses: actions/upload-artifact@v4.6.0
        with:
          name: ${{ inputs.artifactName }}
          path: build/app/outputs/bundle/release
          retention-days: 1
